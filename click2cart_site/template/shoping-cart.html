{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Carrito</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->	
	<link rel="icon" type="image/png" href="{% static '/images/icons/topicon.png' %}"/>
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/vendor/bootstrap/css/bootstrap.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/fonts/font-awesome-4.7.0/css/font-awesome.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/fonts/iconic/css/material-design-iconic-font.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/fonts/linearicons-v1.0.0/icon-font.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/vendor/animate/animate.css' %}">
<!--===============================================================================================-->	
	<link rel="stylesheet" type="text/css" href="{% static '/vendor/css-hamburgers/hamburgers.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/vendor/animsition/css/animsition.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/vendor/select2/select2.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/vendor/perfect-scrollbar/perfect-scrollbar.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static '/css/util.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static '/css/main.css' %}">
<!--===============================================================================================-->
</head>
<body class="animsition">
	
	<!-- Header -->
	<header class="header-v2">
		<!-- Header desktop -->
		<div class="container-menu-desktop trans-03">
			<div class="wrap-menu-desktop">
				<nav class="limiter-menu-desktop p-l-45">
					
					<!-- Logo desktop -->		
					<a href="#" class="logo">
						<img src="{% static '/images/icons/click2cart_logo.png' %}" alt="IMG-LOGO">
					</a>

					<!-- Menu desktop -->
					<div class="menu-desktop">
						<ul class="main-menu">
							<li class="active-menu">
								<a href="back">Inicio</a>
								
							</li>

							<li>
								<a href="producto">Vender</a>
							</li>

							<li>
								<a href="logout">Cerrar sesion</a>
							</li>

						</ul>
					</div>	

					<!-- Icon header -->
					<div class="wrap-icon-header flex-w flex-r-m h-full">

						<div class="flex-c-m h-full p-l-18 p-r-25 bor5">
							<a href="carrito" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">
								Carrito
							</a>
						</div>
							
						<div class="flex-c-m h-full p-lr-19">
							<a href="historial" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">
								Historial
							</a>
						</div>
					</div>
				</nav>
			</div>	
		</div>
	</header>

	<!-- Cart -->
	

	<!-- breadcrumb -->
	<div class="container">
		<div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
			<a href="back" class="stext-109 cl8 hov-cl1 trans-04">
				Home
				<i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
			</a>

			<span class="stext-109 cl4">
				Carrito
			</span>
		</div>
	</div>
		

	<!-- Shoping Cart -->
	<form class="bg0 p-t-75 p-b-85" method="post" action="{% url 'comprar' %}">
		{% csrf_token %}
		<div class="container">
			<div class="row">
				<div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
					<div class="m-l-25 m-r--38 m-lr-0-xl">
						<div class="wrap-table-shopping-cart">
							<table class="table-shopping-cart">
								<tr class="table_head">
									<th class="column-1">Producto</th>
									<th class="column-2"></th>
									<th class="column-3">Precio</th>
									<th class="column-5">Cantidad</th>
									<th class="column-5">Eliminar</th>
								</tr>
								{% for producto in productocarrito %}
								<tr class="table_row">
									<td class="column-1">
										<div class="how-itemcart1">
											<img src="{{ producto.linkimage.url }}" alt="IMG">
										</div>
									</td>
									<td class="column-2">{{ producto.nombre }}</td>
									<td class="column-3">$ {{ producto.precio }}</td>
									<td class="column-5">{{ producto.cantidad }}</td>
									<td class="column-5">
										<button type="button" class="eliminar-btn" data-producto-id="{{ producto.id_producto }}">Eliminar</button>
									</td>
								</tr>
								{% endfor %}
							</table>
						</div>
					</div>
				</div>

				<div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
					<div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
						<h4 class="mtext-109 cl2 p-b-30">
							Total Carrito
						</h4>
	

						<div class="flex-w flex-t bor12 p-b-13">
							<div class="size-208">
								<span class="stext-110 cl2">
									Subtotal:
								</span>
							</div>

							<div class="size-209">
								<span class="mtext-110 cl2">
									$ {{ precio_final }}
								</span>
							</div>
						</div>

						<div class="flex-w flex-t bor12 p-t-15 p-b-30">
							<div class="size-208 w-full-ssm">
								<span class="stext-110 cl2">
									Envio:
								</span>
							</div>
							<div class="bor8 bg0 m-b-12"style="width: 100%;">
								<input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="state" placeholder="Departamento /  Ciudad / Direccion" required>
							</div>
							<span id = "fecha_actual" class="stext-110 cl2">
							</span>
						</div>

						<div class="flex-w flex-t p-t-27 p-b-33">
							<div class="size-208">
								<span class="mtext-101 cl2">
									Total:
								</span>
							</div>

							<div class="size-209 p-t-1">
								<span class="mtext-110 cl2">
									$ {{ precio_final }}
								</span>
							</div>
						</div>

						<button type="button" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer btn-comprar">
							Comprar
						</button>
					</div>
				</div>
			</div>
		</div>
	</form>
		
	
		

	<!-- Footer -->
	


	<!-- Back to top -->
	<div class="btn-back-to-top" id="myBtn">
		<span class="symbol-btn-back-to-top">
			<i class="zmdi zmdi-chevron-up"></i>
		</span>
	</div>

<!--===============================================================================================-->	
	<script src="{% static '/vendor/jquery/jquery-3.2.1.min.js' %}"></script>
<!--===============================================================================================-->
	<script src="{% static '/vendor/animsition/js/animsition.min.js' %}"></script>
<!--===============================================================================================-->
	<script src="{% static '/vendor/bootstrap/js/popper.js' %}"></script>
	<script src="{% static '/vendor/bootstrap/js/bootstrap.min.js' %}"></script>
<!--===============================================================================================-->
	<script src="{% static '/vendor/select2/select2.min.js' %}"></script>
	<script src="{% static '/vendor/sweetalert/sweetalert.min.js' %}"></script>
	<script>
		$(document).ready(function(){
    $('.btn-comprar').on('click', function(){
        var direccion = $('input[name="state"]').val(); // Obtener la dirección de entrega del formulario
        $.ajax({
            type: "POST",
            url: "{% url 'comprar' %}", // URL a la vista de compra
            data: {'direccion': direccion}, // Enviar la dirección de entrega al servidor
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                // En caso de éxito, mostrar un SweetAlert de éxito
                swal("Compra exitosa", "¡Tu compra ha sido realizada con éxito!", "success").then((value) => {
                    // Redirigir a la página de historial
                    window.location.href = "{% url 'historial' %}";
                });
            },
            error: function(xhr, status, error) {
                // En caso de error, mostrar un SweetAlert de error
                swal("Error", "Ha ocurrido un error al procesar tu compra. Por favor, inténtalo de nuevo más tarde.", "error");
            }
        });
    });
});

	</script>
	<script>
		$(".js-select2").each(function(){
			$(this).select2({
				minimumResultsForSearch: 20,
				dropdownParent: $(this).next('.dropDownSelect2')
			});
		})
	</script>
<!--===============================================================================================-->
	<script src="{% static '/vendor/MagnificPopup/jquery.magnific-popup.min.js' %}"></script>
<!--===============================================================================================-->
	<script src="{% static '/vendor/perfect-scrollbar/perfect-scrollbar.min.js' %}"></script>
	<script>
		$('.js-pscroll').each(function(){
			$(this).css('position','relative');
			$(this).css('overflow','hidden');
			var ps = new PerfectScrollbar(this, {
				wheelSpeed: 1,
				scrollingThreshold: 1000,
				wheelPropagation: false,
			});

			$(window).on('resize', function(){
				ps.update();
			})
		});
	</script>
<!--===============================================================================================-->
	<script src="{% static '/js/main.js' %}"></script>

	<script>
        // Obtener la fecha actual
        var fecha = new Date();
        
        // Convertir la fecha a formato legible para humanos
        var opciones = { year: 'numeric', month: 'long', day: 'numeric' };
        var fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);
        
        // Mostrar la fecha en el elemento con id "fecha_actual"
        document.getElementById('fecha_actual').innerText = "Fecha actual: " + fechaFormateada;
    </script>
	<script>
        $(document).ready(function(){
            $('.js-comprar').on('click', function(){
                $.ajax({
                    type: "POST",
                    url: "/comprar/",
                    data: {
                        'state': $('input[name="state"]').val(),
                    },
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            Swal.fire(
                                '¡Éxito!',
                                response.message,
                                'success'
                            ).then(() => {
                                window.location.href = "/historial";
                            });
                        }
                    },
                    error: function(xhr) {
                        var response = JSON.parse(xhr.responseText);
                        Swal.fire(
                            'Error',
                            response.message,
                            'error'
                        );
                    }
                });
            });
        });
    </script>

<script>
	// Obtener todos los botones de eliminar por su clase
	var eliminarButtons = document.querySelectorAll(".eliminar-btn");
	
	// Iterar sobre cada botón de eliminar
	eliminarButtons.forEach(function(button) {
		// Agregar un event listener para el clic en cada botón
		button.addEventListener("click", function() {
			// Obtener el ID del producto desde el atributo data-producto-id
			var productId = button.getAttribute("data-producto-id");
			
			// Crear una nueva solicitud AJAX
			var xhr = new XMLHttpRequest();
			xhr.open("POST", "{% url 'eliminar_producto_carrito' %}", true);
			xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			xhr.onload = function() {
				if (xhr.status >= 200 && xhr.status < 300) {
					// Recargar la página u otra acción después de eliminar el producto
					location.reload();
				} else {
					// Manejar errores si es necesario
					console.error(xhr.statusText);
				}
			};
			// Enviar el ID del producto en el cuerpo de la solicitud
			var data = "producto_id=" + productId;
			xhr.send(data);
		});
	});
</script>
</body>
</html>